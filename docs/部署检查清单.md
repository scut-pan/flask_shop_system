# 部署前检查清单

在部署到生产环境之前,请确认完成以下所有项目:

## ✅ 1. 代码准备

- [ ] 代码已提交到 Git 仓库
- [ ] 所有测试用例通过 (`uv run pytest`)
- [ ] 代码符合 PEP 8 规范 (`uv run flake8`)
- [ ] `.env` 文件已添加到 `.gitignore`
- [ ] 敏感信息(密钥、密码等)未硬编码在代码中

## ✅ 2. 配置文件检查

- [ ] `.env.production` 已复制为 `.env`
- [ ] `SECRET_KEY` 已设置为强随机字符串(至少32位)
- [ ] MySQL 密码已修改为强密码
- [ ] 数据库连接配置正确
- [ ] 邮件配置正确(服务器、端口、用户名、授权码)
- [ ] `FLASK_ENV` 设置为 `production`
- [ ] `FLASK_DEBUG` 设置为 `0` 或 `False`

## ✅ 3. 服务器准备

- [ ] Docker 已安装(版本 20.10+)
- [ ] Docker Compose 已安装(版本 2.0+)
- [ ] 服务器内存 >= 4GB
- [ ] 服务器磁盘空间 >= 40GB
- [ ] 防火墙已配置(开放 80、443 端口)
- [ ] SSH 访问正常

## ✅ 4. 域名和 SSL (可选)

- [ ] 域名已购买并指向服务器 IP
- [ ] DNS 解析已生效
- [ ] SSL 证书已申请(Let's Encrypt 或其他)
- [ ] HTTPS 配置已测试

## ✅ 5. 部署步骤

- [ ] 项目代码已上传到服务器
- [ ] `.env` 文件已配置
- [ ] Docker 镜像已构建(`docker compose build`)
- [ ] 所有容器已启动(`docker compose up -d`)
- [ ] 数据库已迁移(`docker compose exec web flask db upgrade`)
- [ ] 管理员账户已创建
- [ ] 默认密码已修改

## ✅ 6. 功能测试

- [ ] 网站主页可以访问
- [ ] 用户注册功能正常
- [ ] 用户登录功能正常
- [ ] 商品展示正常
- [ ] 购物车功能正常
- [ ] 下单功能正常
- [ ] 邮件发送功能正常
- [ ] 管理员后台可以访问
- [ ] 图片上传功能正常
- [ ] 静态文件加载正常

## ✅ 7. 性能和监控

- [ ] 页面加载速度正常
- [ ] 数据库查询正常
- [ ] 日志文件正常写入
- [ ] 容器资源使用正常(CPU、内存)
- [ ] 磁盘空间充足

## ✅ 8. 安全检查

- [ ] 默认密码已修改
- [ ] 管理员账户密码强度足够
- [ ] 不必要的端口已关闭
- [ ] SSH 密钥认证已配置(推荐)
- [ ] 定期备份计划已设置

## ✅ 9. 备份和恢复

- [ ] 数据库备份脚本已配置
- [ ] 文件备份脚本已配置
- [ ] 定时任务已设置(crontab)
- [ ] 备份文件存储位置已确认
- [ ] 恢复流程已测试

## ✅ 10. 文档和报告

- [ ] 部署文档已完善
- [ ] 测试账户信息已记录
- [ ] 网站访问地址已记录
- [ ] 实验报告已完成
- [ ] 代码仓库地址已记录

---

## 🚀 快速部署命令

```bash
# 1. 配置环境变量
cp .env.production .env
nano .env

# 2. 一键部署
chmod +x deploy.sh
bash deploy.sh prod

# 3. 查看状态
docker compose ps
docker compose logs -f

# 4. 创建管理员账户
docker compose exec web python -c "
from app import create_app
from app.extensions import db
from app.models import User
from werkzeug.security import generate_password_hash

app = create_app('production')
with app.app_context():
    admin = User(
        username='admin',
        email='admin@example.com',
        password_hash=generate_password_hash('YourStrongPassword'),
        is_admin=True
    )
    db.session.add(admin)
    db.session.commit()
    print('管理员账户创建成功!')
"
```

## 📋 实验报告需要的信息

部署完成后,请在实验报告中记录:

1. **部署地址**:
   - 服务器 IP: `_______________`
   - 域名(如有): `_______________`
   - 访问地址: `http://_______________`

2. **测试账户**:
   - 管理员用户名: `admin`
   - 管理员密码: `_______________`
   - 普通用户(注册): `_______________`

3. **代码仓库**:
   - GitHub/Gitee 地址: `_______________`

4. **部署截图**:
   - 网站主页截图
   - 商品列表截图
   - 购物车截图
   - 订单列表截图
   - 管理员后台截图

5. **功能测试结果**:
   - 用户注册/登录: ✅/❌
   - 商品浏览/搜索: ✅/❌
   - 购物车功能: ✅/❌
   - 下单流程: ✅/❌
   - 邮件通知: ✅/❌
   - 管理员功能: ✅/❌

## 🔧 常见问题处理

### 端口被占用
```bash
# 检查端口占用
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :3306

# 修改 docker-compose.yml 中的端口映射
ports:
  - "8080:80"  # 使用 8080 端口
```

### 数据库连接失败
```bash
# 检查 MySQL 容器状态
docker compose ps mysql

# 查看 MySQL 日志
docker compose logs mysql

# 测试连接
docker compose exec web python -c "
from app import create_app
app = create_app()
with app.app_context():
    from app.extensions import db
    db.session.execute(db.text('SELECT 1'))
    print('数据库连接成功!')
"
```

### 容器启动失败
```bash
# 查看详细日志
docker compose logs

# 重新构建镜像
docker compose build --no-cache

# 检查磁盘空间
df -h
```

## 📞 获取帮助

如遇到问题:
1. 查看详细的 [Docker 部署指南](Docker部署指南.md)
2. 检查容器日志: `docker compose logs -f`
3. 检查服务状态: `docker compose ps`
4. 参考项目 README.md

---

**祝你部署顺利! 🎉**
